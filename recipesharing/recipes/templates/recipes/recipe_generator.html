{% extends "recipes/base.html" %}
{% load static %}

{% block title %}AI Recipe Generator{% endblock %}

{% block content %}
<div class="container mt-5 mb-5 recipe-generator-container">
    <div class="row">
        <div class="col-md-12 text-center mb-4">
            <h1 class="display-4">AI Recipe Generator</h1>
            <p class="lead">Enter ingredients you have, and let AI create a delicious recipe for you!</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card recipe-generator-card shadow-sm">
                <div class="card-header">
                    <h3 class="mb-0">Your Ingredients</h3>
                </div>
                <div class="card-body">
                    <div class="recipe-generator-form">
                        <div class="input-group mb-3">
                            <input type="text" id="ingredient-input" class="form-control" placeholder="Enter an ingredient">
                            <div class="input-group-append">
                                <button class="btn recipe-generator-btn" id="add-ingredient">Add</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dietary-preferences" class="form-label">Dietary Preferences (Optional)</label>
                            <select id="dietary-preferences" class="form-select">
                                <option value="">None</option>
                                <option value="vegetarian">Vegetarian</option>
                                <option value="vegan">Vegan</option>
                                <option value="gluten-free">Gluten-Free</option>
                                <option value="dairy-free">Dairy-Free</option>
                                <option value="keto">Keto</option>
                                <option value="low-carb">Low-Carb</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="ingredients-list mb-3">
                        <h4>Your Ingredients:</h4>
                        <ul id="ingredients-container" class="list-group">
                            <!-- Ingredients will be added here dynamically -->
                        </ul>
                    </div>
                    
                    <button id="generate-recipe" class="btn recipe-generator-btn generate-btn btn-lg w-100">Generate Recipe</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card recipe-generator-card shadow-sm">
                <div class="card-header">
                    <h3 class="mb-0">Your Recipe</h3>
                </div>
                <div class="card-body">
                    <div id="loading-spinner" class="recipe-loading-spinner d-none py-5">
                        <div class="custom-loader">
                            <div class="pan">
                                <div class="food"></div>
                            </div>
                            <div class="handle"></div>
                            <div class="pan-shadow"></div>
                        </div>
                        <p class="mt-3" id="loading-message">Dusting off grandma's secret recipe book...</p>
                    </div>
                    
                    <div id="recipe-container" class="recipe-result">
                        <!-- Recipe will be displayed here -->
                        <div class="text-center text-muted py-5" id="recipe-placeholder">
                            <i class="fas fa-utensils fa-3x mb-3"></i>
                            <p>Your recipe will appear here</p>
                            <p class="small">Add some ingredients and click "Generate Recipe"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Recipe Generator Script Loaded");
        
        const ingredientInput = document.getElementById('ingredient-input');
        const addIngredientBtn = document.getElementById('add-ingredient');
        const ingredientsContainer = document.getElementById('ingredients-container');
        const generateRecipeBtn = document.getElementById('generate-recipe');
        const recipeContainer = document.getElementById('recipe-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingMessage = document.getElementById('loading-message');
        const dietaryPreferences = document.getElementById('dietary-preferences');
        
        // Check if elements exist
        if (!ingredientInput) console.error("Ingredient input not found");
        if (!addIngredientBtn) console.error("Add ingredient button not found");
        if (!ingredientsContainer) console.error("Ingredients container not found");
        if (!generateRecipeBtn) console.error("Generate recipe button not found");
        if (!recipeContainer) console.error("Recipe container not found");
        
        let ingredients = [];
        
        // Add ingredient from input
        function addIngredient() {
            console.log("Add ingredient clicked");
            const ingredient = ingredientInput.value.trim();
            if (ingredient && !ingredients.includes(ingredient)) {
                ingredients.push(ingredient);
                updateIngredientsList();
                ingredientInput.value = '';
            }
            ingredientInput.focus();
        }
        
        // Update the ingredients list in the UI
        function updateIngredientsList() {
            console.log("Updating ingredients list", ingredients);
            ingredientsContainer.innerHTML = '';
            
            if (ingredients.length === 0) {
                ingredientsContainer.innerHTML = '<li class="list-group-item text-muted">No ingredients added yet</li>';
                return;
            }
            
            ingredients.forEach((ingredient, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    ${ingredient}
                    <button type="button" class="btn btn-sm btn-danger" data-index="${index}">
                        <i class="fas fa-times"></i> Remove
                    </button>
                `;
                ingredientsContainer.appendChild(li);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('[data-index]').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    ingredients.splice(index, 1);
                    updateIngredientsList();
                });
            });
        }
        
        // Helper function to format recipe text
        function formatRecipe(recipeText) {
            // Detect if recipe is already in a structured format or free text
            const hasTitle = recipeText.includes('**') || recipeText.includes('#');
            
            if (hasTitle) {
                // Process markdown-style formatting
                let formatted = recipeText;
                
                // Format headings and titles (** text ** or # text)
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<h3 class="recipe-title mb-3">$1</h3>');
                formatted = formatted.replace(/^# (.*?)$/gm, '<h3 class="recipe-title mb-3">$1</h3>');
                formatted = formatted.replace(/^\*\*\* (.*?):/gm, '<h4 class="recipe-section mt-4 mb-2">$1:</h4>');
                
                // Format lists (* text)
                formatted = formatted.replace(/^\* (.*?)$/gm, '<li class="recipe-list-item">$1</li>');
                
                // Wrap lists in ul tags
                formatted = formatted.replace(/<li class="recipe-list-item">(.*?)<\/li>\n<li class="recipe-list-item">/g, 
                                            '<ul class="recipe-ingredients-list"><li class="recipe-list-item">$1</li><li class="recipe-list-item">');
                formatted = formatted.replace(/<li class="recipe-list-item">(.*?)<\/li>\n(?!<li)/g, 
                                            '<ul class="recipe-ingredients-list"><li class="recipe-list-item">$1</li></ul>');
                
                // Format numbered steps (1. text)
                formatted = formatted.replace(/^(\d+)\.\s+(.*?)$/gm, '<div class="recipe-step"><span class="recipe-step-number">$1</span><span class="recipe-step-text">$2</span></div>');
                
                // Format sections like "Instructions:"
                formatted = formatted.replace(/^\*\*(.*?):\*\*$/gm, '<h4 class="recipe-section mt-4 mb-2">$1:</h4>');
                
                return formatted;
            } else {
                // Simple formatting for free text
                return `<div class="recipe-content-simple">${recipeText.replace(/\n/g, '<br>')}</div>`;
            }
        }
        
        // Generate recipe
        async function generateRecipe() {
            console.log("Generate recipe clicked", ingredients);
            if (ingredients.length === 0) {
                alert('Please add at least one ingredient');
                return;
            }
            
            // Show loading spinner with first message
            loadingSpinner.classList.remove('d-none');
            document.getElementById('recipe-placeholder')?.remove();
            recipeContainer.innerHTML = '';
            loadingMessage.textContent = "Dusting off grandma's secret recipe book...";
            
            // Setup loading messages in the sequence we want
            const loadingMessages = [
                "Dusting off grandma's secret recipe book...",
                "Consulting with virtual Gordon Ramsay...",
                "Running final flavor diagnostics..."
            ];
            
            try {
                // First loading message is already set
                
                // Send the request
                console.log("Sending request to generate recipe API");
                const apiUrl = '{% url "generate_recipe_api" %}';
                
                // Show second message
                setTimeout(() => {
                    loadingMessage.textContent = loadingMessages[1];
                }, 800);
                
                // Send API request
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        ingredients: ingredients,
                        dietary_preferences: dietaryPreferences.value
                    }),
                });
                
                // Show third message right before processing response
                setTimeout(() => {
                    loadingMessage.textContent = loadingMessages[2];
                }, 1600);
                
                // Add a small delay to ensure the last message is seen
                await new Promise(resolve => setTimeout(resolve, 500));
                
                console.log("Response received:", response.status);
                const data = await response.json();
                console.log("Data:", data);
                
                // Process the response after showing the final message
                setTimeout(() => {
                    if (response.ok) {
                        // Format the recipe with better styling
                        const formattedRecipe = formatRecipe(data.recipe);
                        
                        // Create recipe card with styled content
                        recipeContainer.innerHTML = `
                            <div class="recipe-content-card">
                                ${formattedRecipe}
                            </div>`;
                        
                        // Add action buttons
                        const actionButtons = document.createElement('div');
                        actionButtons.className = 'recipe-actions mt-4 d-flex gap-2';
                        
                        // Save button
                        const saveButton = document.createElement('button');
                        saveButton.className = 'btn save-recipe-btn';
                        saveButton.innerHTML = '<i class="fas fa-save"></i> Save Recipe';
                        saveButton.addEventListener('click', function() {
                            alert('This feature will be implemented soon!');
                        });
                        
                        // Print button
                        const printButton = document.createElement('button');
                        printButton.className = 'btn print-recipe-btn';
                        printButton.innerHTML = '<i class="fas fa-print"></i> Print';
                        printButton.addEventListener('click', function() {
                            window.print();
                        });
                        
                        actionButtons.appendChild(saveButton);
                        actionButtons.appendChild(printButton);
                        recipeContainer.appendChild(actionButtons);
                        
                    } else {
                        // Display error
                        recipeContainer.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to generate recipe'}</div>`;
                    }
                    
                    // Hide loading spinner
                    loadingSpinner.classList.add('d-none');
                }, 1000);
                
            } catch (error) {
                console.error("Error generating recipe:", error);
                
                // Show final message before displaying error
                loadingMessage.textContent = loadingMessages[2];
                
                // Small delay before showing error
                setTimeout(() => {
                    recipeContainer.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                    loadingSpinner.classList.add('d-none');
                }, 1000);
            }
        }
        
        // Attach event listeners
        console.log("Attaching event listeners");
        addIngredientBtn.addEventListener('click', addIngredient);
        ingredientInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addIngredient();
            }
        });
        generateRecipeBtn.addEventListener('click', generateRecipe);
        
        // Initialize the ingredients list
        updateIngredientsList();
    });
</script>
{% endblock %}